<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë‚˜ì˜ í‘œì • ë¶„ì„ê¸°</title>

    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.0/css/bootstrap.min.css">

    <!-- Webcam.js & ML5 -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/webcamjs/1.0.26/webcam.min.js"></script>
    <script src="https://unpkg.com/ml5@0.4.3/dist/ml5.min.js"></script>

    <style>
        p {
            font-family: CookieRun-Regular;
        }
        body {
            color: white;
            background: #f8f5de;
            text-align: center;
            padding: 20px;
        }

        .container {
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .camera-container {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-bottom: 20px;
        }

        #camera, #result {
            border: 2px dashed black;
            width: 350px;
            height: 300px;
        }

        .emotion_name {
            font-size: 30px;
            color: black;
        }

        .emoji {
            font-size: 48px;
        }

        .heading {
            font-size: 20px;
            border-radius: 10px;
            padding: 10px;
            background: rgb(89, 95, 69);
            display: inline-block;
        }

        .task-text {
            position: absolute;
            top: 10px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 24px;
            color: black;
            background: rgb(229, 240, 200);
            padding: 10px;
            border-radius: 10px;
        }
        @font-face {
    font-family: 'CookieRun-Regular';
    src: url('https://fastly.jsdelivr.net/gh/projectnoonnu/noonfonts_2001@1.1/CookieRun-Regular.woff') format('woff');
    font-weight: normal;
    font-style: normal;
        }
        .t1 {
            font-family: CookieRun-Regular;
            font-size: 25px;
            position: relative;
            left: 50%;
            transform: translateX(-50%);
            top: 0px;
            color: rgb(38, 34, 10);
        }
        .to-main {
            right: 40px;
            font-family: CookieRun-Regular;
            font-size: 30px;
            bottom: 10%;
            background-color: rgb(220, 205, 116);
            color: rgb(21, 19, 5);
            padding: 10px;
            cursor: pointer;
            position: absolute;
            border-radius: 8px;
            transition: 0.3s;
        }
        .to-main:hover {
            transform: scale(1.2);
            opacity: 0.8;
            background-color: rgb(21, 19, 5);
            color: rgb(232, 226, 194);
        }
    </style>
</head>

<body>
    <p id="taskText" class="task-text"></p>
    <a href="main.html"><p class="to-main">ë©”ì¸ìœ¼ë¡œ</p></a>
    <div class="container">
        <h3 class="heading">ë‚˜ì˜ í‘œì • ë¶„ì„ê¸°</h3>

        <div class="camera-container">
            <div>
                <p class = "t1">ë‚˜ì˜ í‘œì •</p>
                
                <div id="camera"></div>
            </div>

            <div>
               <p class = "t1">ë¶„ì„í•œ í‘œì •</p>
                <div id="result"></div>
            </div>
        </div>

        <button class="btn btn-warning" onclick="take_snapshot();">í‘œì • ìº¡ì³í•˜ê¸°</button>

        <div class="results-container">
            <div class="emotion-box">
                <label>í˜„ì¬ í‘œì •ì€</label>
                <p class="emotion_name" id="result_emotion_name"></p>
                <p class="emoji" id="update_emoji"></p>
            </div>
        </div>
    </div>

    <script>
        let prediction = "";
        let tasks = [
            { text: "í–‰ë³µí•œ í‘œì •ì„ ì§€ì–´ë´ìš”", emotion: "happy" },
            { text: "í™”ë‚œ í‘œì •ì„ ì§€ì–´ë´ìš”", emotion: "angry" },
            { text: "ìŠ¬í”ˆ í‘œì •ì„ ì§€ì–´ë´ìš”", emotion: "sad" }
        ];
        let currentTask = null;
        let incorrectAttempts = 0;
        
        function getRandomTask(excludeTask) {
            let availableTasks = tasks.filter(task => task !== excludeTask);
            return availableTasks[Math.floor(Math.random() * availableTasks.length)];
        }
        
        function updateTask() {
            currentTask = getRandomTask(currentTask);
            document.getElementById("taskText").innerText = currentTask.text;
            incorrectAttempts = 0;
        }
        
        document.addEventListener("DOMContentLoaded", function () {
            Webcam.set({
                width: 350,
                height: 300,
                image_format: 'png',
                png_quality: 90
            });

            Webcam.attach('#camera');

            console.log('ml5 version:', ml5.version);

            classifier = ml5.imageClassifier('https://teachablemachine.withgoogle.com/models/5mxzZHkpx/model.json', function () {
                console.log('ëª¨ë¸ì´ ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤!');
                updateTask();
            });
        });

        function take_snapshot() {
            Webcam.snap(function (data_uri) {
                document.getElementById("result").innerHTML = `<img id="captured_image" src="${data_uri}"/>`;
                setTimeout(check, 500);
            });
        }

        function speak() {
            let synth = window.speechSynthesis;
            let speak_data = "ë¶„ì„í•œ í‘œì •ì€" + prediction +"ì…ë‹ˆë‹¤.";
            let utterThis = new SpeechSynthesisUtterance(speak_data);
            synth.speak(utterThis);
        }

        function check() {
            let img = document.getElementById('captured_image');
            if (!img) {
                alert("ì‚¬ì§„ì„ ë¨¼ì € ì°ì–´ì£¼ì„¸ìš”!");
                return;
            }
            classifier.classify(img, gotResult);
        }

        function gotResult(error, results) {
            if (error) {
                console.error(error);
            } else {
                console.log(results);
                prediction = results[0].label;
                let emojiMap = {
                    "happy": { text: "ê¸°ë»ìš”", emoji: "ğŸ˜Š" },
                    "sad": { text: "ìŠ¬í¼ìš”", emoji: "ğŸ˜¢" },
                    "angry": { text: "í™”ë‚˜ìš”", emoji: "ğŸ˜¡" }
                };
                let resultText = emojiMap[prediction] ? emojiMap[prediction].text : "ì•Œ ìˆ˜ ì—†ìŒ";
                let resultEmoji = emojiMap[prediction] ? emojiMap[prediction].emoji : "â“";
                
                document.getElementById("result_emotion_name").innerHTML = resultText;
                document.getElementById("update_emoji").innerHTML = resultEmoji;
                
                if (prediction === currentTask.emotion) {
                    updateTask();
                } else {
                    incorrectAttempts++;
                    if (incorrectAttempts >= 2) {
                        updateTask();
                    }
                }
                speak();
            }
        }
    </script>
</body>
</html>
